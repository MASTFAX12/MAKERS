<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الدخول الآمن | MAK Team HQ</title>
    <meta name="description" content="الدخول عبر روابط دعوة مؤقتة في MAK Team HQ">
    <meta name="theme-color" content="#0a0a0f">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/responsive.css">

    <link rel="icon" href="assets/images/logo.jpg" type="image/jpeg">

    <style>
        * {
            font-family: 'Inter', 'Tajawal', sans-serif;
        }

        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background: #0a0a0f;
        }

        .login-page::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 0%, rgba(0, 100, 180, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(0, 60, 120, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .login-container {
            width: 100%;
            max-width: 520px;
            position: relative;
            z-index: 1;
        }

        .login-card {
            background: rgba(18, 18, 26, 0.86);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 2rem;
            animation: fadeIn 0.4s ease;
        }

        .login-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .login-logo {
            width: 72px;
            height: 72px;
            border-radius: 14px;
            margin-bottom: 1rem;
            border: 2px solid rgba(0, 168, 255, 0.3);
        }

        .login-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 0.4rem;
        }

        .login-subtitle {
            color: rgba(255, 255, 255, 0.55);
            font-size: 0.95rem;
        }

        .status-box {
            display: none;
            margin-bottom: 1rem;
            padding: 0.9rem 1rem;
            border-radius: 10px;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .status-box.info {
            display: block;
            background: rgba(59, 130, 246, 0.14);
            border: 1px solid rgba(59, 130, 246, 0.4);
            color: #93c5fd;
        }

        .status-box.success {
            display: block;
            background: rgba(34, 197, 94, 0.12);
            border: 1px solid rgba(34, 197, 94, 0.4);
            color: #86efac;
        }

        .status-box.error {
            display: block;
            background: rgba(239, 68, 68, 0.12);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #fca5a5;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.6rem;
            font-weight: 500;
            font-size: 0.88rem;
            color: rgba(255, 255, 255, 0.75);
        }

        .form-label i {
            width: 16px;
            height: 16px;
        }

        .form-input {
            width: 100%;
            padding: 0.8rem 0.9rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.14);
            border-radius: 10px;
            color: #fff;
            font-size: 0.9rem;
            direction: ltr;
            text-align: left;
        }

        .form-input:focus {
            outline: none;
            border-color: #0084ff;
            box-shadow: 0 0 0 3px rgba(0, 132, 255, 0.14);
        }

        .login-btn {
            width: 100%;
            padding: 0.9rem;
            font-size: 0.95rem;
            font-weight: 600;
            background: linear-gradient(135deg, #0084ff, #0066cc);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.55rem;
            transition: all 0.2s ease;
        }

        .login-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(0, 132, 255, 0.3);
        }

        .login-btn.secondary {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.85);
        }

        .helper-text {
            margin-top: 1rem;
            font-size: 0.83rem;
            color: rgba(255, 255, 255, 0.55);
            line-height: 1.7;
        }

        .setup-panel {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .output-row {
            display: none;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .output-row .form-input {
            flex: 1;
        }

        .output-row .btn-copy {
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.04);
            border-radius: 10px;
            color: #fff;
            padding: 0 1rem;
            cursor: pointer;
        }

        .back-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.2rem;
            color: rgba(255, 255, 255, 0.45);
            font-size: 0.85rem;
        }

        .back-link:hover {
            color: #0084ff;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <div class="login-page">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <img src="assets/images/logo.jpg" alt="MAK" class="login-logo">
                    <h1 class="login-title">MAK Team HQ</h1>
                    <p class="login-subtitle">الدخول يتم فقط عبر رابط آمن ومؤقت</p>
                </div>

                <div id="statusBox" class="status-box"></div>

                <form id="linkForm">
                    <div class="form-group">
                        <label class="form-label" for="accessLink">
                            <i data-lucide="link"></i>
                            ألصق رابط الدخول (دعوة أو قائد)
                        </label>
                        <input id="accessLink" class="form-input" type="text" placeholder="https://..." autocomplete="off"
                            required>
                    </div>
                    <button type="submit" class="login-btn">
                        <span>متابعة</span>
                        <i data-lucide="arrow-left"></i>
                    </button>
                </form>

                <div id="leaderSetupPanel" class="setup-panel">
                    <button id="generateLeaderLinkBtn" type="button" class="login-btn secondary">
                        <i data-lucide="crown"></i>
                        <span>توليد رابط القائد</span>
                    </button>

                    <div id="leaderOutput" class="output-row">
                        <input id="leaderLinkOut" class="form-input" type="text" readonly>
                        <button id="copyLeaderLinkBtn" type="button" class="btn-copy">نسخ</button>
                    </div>
                </div>

                <p class="helper-text">
                    ملاحظة: لا يوجد تسجيل بكلمة مرور أو PIN.
                    الانضمام يتم عبر رابط مؤقت من القائد فقط.
                </p>

                <a href="index.html" class="back-link">
                    <span>العودة للرئيسية</span>
                    <i data-lucide="arrow-right"></i>
                </a>
            </div>
        </div>
    </div>

    <script src="js/storage.js"></script>
    <script src="js/firebase.js"></script>
    <script src="js/firebase-db.js"></script>
    <script src="js/auth.js"></script>

    <script>
        const statusBox = document.getElementById('statusBox');
        const linkForm = document.getElementById('linkForm');
        const linkInput = document.getElementById('accessLink');
        const leaderSetupPanel = document.getElementById('leaderSetupPanel');
        const generateLeaderLinkBtn = document.getElementById('generateLeaderLinkBtn');
        const leaderOutput = document.getElementById('leaderOutput');
        const leaderLinkOut = document.getElementById('leaderLinkOut');
        const copyLeaderLinkBtn = document.getElementById('copyLeaderLinkBtn');

        function showStatus(message, type = 'info') {
            statusBox.className = `status-box ${type}`;
            statusBox.textContent = message;
        }

        function clearStatus() {
            statusBox.className = 'status-box';
            statusBox.textContent = '';
        }

        function parseAccessLink(value) {
            let parsed;

            if (value.startsWith('?')) {
                parsed = new URL(window.location.origin + '/login.html' + value);
            } else {
                parsed = new URL(value);
            }

            const invite = parsed.searchParams.get('invite');
            const token = parsed.searchParams.get('token');
            const leaderToken = parsed.searchParams.get('leaderToken');

            return { invite, token, leaderToken };
        }

        async function handleInviteLogin(invite, token) {
            showStatus('جاري التحقق من رابط الدعوة...', 'info');
            const result = await Auth.consumeInvite({ id: invite, token });

            if (!result.success) {
                showStatus(result.message, 'error');
                return;
            }

            showStatus('تم الانضمام بنجاح. جاري التحويل...', 'success');
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 500);
        }

        async function handleLeaderLogin(leaderToken) {
            showStatus('جاري التحقق من رابط القائد...', 'info');
            const result = await Auth.loginLeaderWithToken(leaderToken);

            if (!result.success) {
                showStatus(result.message, 'error');
                return;
            }

            showStatus('تم دخول القائد بنجاح. جاري التحويل...', 'success');
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 500);
        }

        function cleanUrl() {
            const url = new URL(window.location.href);
            url.search = '';
            window.history.replaceState({}, document.title, url.toString());
        }

        async function init() {
            lucide.createIcons();
            Auth.init();

            if (Auth.isLoggedIn()) {
                window.location.href = 'dashboard.html';
                return;
            }

            try {
                if (typeof Firebase !== 'undefined' && Firebase.init) {
                    await Firebase.init();
                }
                if (typeof FirebaseDB !== 'undefined' && FirebaseDB.init) {
                    await FirebaseDB.init();
                }
            } catch (error) {
                console.warn('Firebase init skipped:', error);
            }

            const params = new URLSearchParams(window.location.search);
            const invite = params.get('invite');
            const token = params.get('token');
            const leaderToken = params.get('leaderToken');
            const setup = params.get('setup');

            if (invite && token) {
                await handleInviteLogin(invite, token);
                cleanUrl();
                return;
            }

            if (leaderToken) {
                await handleLeaderLogin(leaderToken);
                cleanUrl();
                return;
            }

            if (setup === 'leader') {
                leaderSetupPanel.style.display = 'block';
                const configured = await Auth.hasLeaderAccessConfigured();
                generateLeaderLinkBtn.querySelector('span').textContent = configured
                    ? 'تدوير رابط القائد'
                    : 'توليد رابط القائد';
                showStatus('وضع تهيئة القائد مفعّل', 'info');
            }
        }

        linkForm.addEventListener('submit', (e) => {
            e.preventDefault();
            clearStatus();

            const raw = linkInput.value.trim();
            if (!raw) {
                showStatus('أدخل رابط الدخول أولاً', 'error');
                return;
            }

            try {
                const parsed = parseAccessLink(raw);

                if (parsed.invite && parsed.token) {
                    window.location.href = Auth.getLoginUrl({ invite: parsed.invite, token: parsed.token });
                    return;
                }

                if (parsed.leaderToken) {
                    window.location.href = Auth.getLoginUrl({ leaderToken: parsed.leaderToken });
                    return;
                }

                showStatus('الرابط لا يحتوي على بيانات دخول صالحة', 'error');
            } catch (error) {
                showStatus('تنسيق الرابط غير صحيح', 'error');
            }
        });

        generateLeaderLinkBtn.addEventListener('click', async () => {
            clearStatus();
            showStatus('جاري توليد رابط القائد...', 'info');

            try {
                const generated = await Auth.rotateLeaderToken();
                leaderLinkOut.value = generated.link;
                leaderOutput.style.display = 'flex';
                showStatus('تم توليد رابط القائد بنجاح', 'success');
            } catch (error) {
                showStatus('تعذر توليد الرابط حالياً', 'error');
            }
        });

        copyLeaderLinkBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(leaderLinkOut.value);
                showStatus('تم نسخ الرابط', 'success');
            } catch (error) {
                leaderLinkOut.select();
                document.execCommand('copy');
                showStatus('تم نسخ الرابط', 'success');
            }
        });

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
